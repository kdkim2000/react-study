# Chapter 14: Next.js API Routes

## 목차
1. [Next.js API 라우트 개념](#1-nextjs-api-라우트-개념)
2. [서버 없는 백엔드 만들기](#2-서버-없는-백엔드-만들기)
3. [실습: 간단한 REST API 구현](#3-실습-간단한-rest-api-구현)

---

## 1. Next.js API 라우트 개념

### 1.1 API Routes란?

Next.js API Routes는 Next.js 애플리케이션 내에서 백엔드 API 엔드포인트를 만들 수 있게 해주는 기능입니다. 별도의 백엔드 서버 없이도 서버 사이드 로직을 구현할 수 있습니다.

**주요 특징:**
- **풀스택 개발**: 프론트엔드와 백엔드를 하나의 프로젝트에서 관리
- **서버리스**: Vercel 등의 플랫폼에서 자동으로 서버리스 함수로 배포
- **타입 안전성**: TypeScript와 완벽 호환
- **미들웨어 지원**: 인증, CORS, 로깅 등 다양한 미들웨어 적용 가능

### 1.2 App Router에서의 API Routes

Next.js 13+의 App Router에서는 `app/api` 디렉토리 내에 `route.ts` 파일을 생성하여 API 엔드포인트를 만듭니다.

**디렉토리 구조:**
```
app/
├── api/
│   ├── users/
│   │   └── route.ts
│   ├── posts/
│   │   ├── route.ts
│   │   └── [id]/
│   │       └── route.ts
│   └── auth/
│       └── route.ts
├── page.tsx
└── layout.tsx
```

### 1.3 HTTP 메서드 지원

API Routes에서는 다양한 HTTP 메서드를 지원합니다:

```typescript
// app/api/example/route.ts
import { NextRequest, NextResponse } from 'next/server'

export async function GET(request: NextRequest) {
  return NextResponse.json({ method: 'GET' })
}

export async function POST(request: NextRequest) {
  return NextResponse.json({ method: 'POST' })
}

export async function PUT(request: NextRequest) {
  return NextResponse.json({ method: 'PUT' })
}

export async function DELETE(request: NextRequest) {
  return NextResponse.json({ method: 'DELETE' })
}

export async function PATCH(request: NextRequest) {
  return NextResponse.json({ method: 'PATCH' })
}
```

---

## 2. 서버 없는 백엔드 만들기

### 2.1 프로젝트 설정

먼저 Next.js 프로젝트를 생성합니다:

```bash
npx create-next-app@latest my-api-app
```

설정 옵션:
```
√ Would you like to use TypeScript? Yes
√ Which linter would you like to use? ESLint
√ Would you like to use Tailwind CSS? Yes
√ Would you like your code inside a `src/` directory? Yes
√ Would you like to use App Router? (recommended) Yes
√ Would you like to use Turbopack? (recommended) Yes
√ Would you like to customize the import alias (`@/*` by default)? Yes
```

Material UI 설치:
```bash
npm install @mui/material @emotion/react @emotion/styled
npm install @mui/icons-material
```

### 2.2 타입 정의

```typescript
// src/types/user.ts
export interface User {
  id: number
  name: string
  email: string
  createdAt: string
  updatedAt: string
}

export interface CreateUserRequest {
  name: string
  email: string
}

export interface UpdateUserRequest {
  name?: string
  email?: string
}

export interface ApiResponse<T> {
  success: boolean
  data?: T
  message?: string
  error?: string
}
```

### 2.3 데이터 저장소 (메모리 기반)

실제 프로덕션에서는 데이터베이스를 사용하지만, 학습 목적으로 메모리 기반 저장소를 구현합니다:

```typescript
// src/lib/data-store.ts
import { User } from '@/types/user'

class DataStore {
  private users: User[] = []
  private nextId = 1

  getAllUsers(): User[] {
    return [...this.users]
  }

  getUserById(id: number): User | undefined {
    return this.users.find(user => user.id === id)
  }

  createUser(name: string, email: string): User {
    const now = new Date().toISOString()
    const newUser: User = {
      id: this.nextId++,
      name,
      email,
      createdAt: now,
      updatedAt: now
    }
    this.users.push(newUser)
    return newUser
  }

  updateUser(id: number, updates: Partial<Omit<User, 'id' | 'createdAt'>>): User | null {
    const userIndex = this.users.findIndex(user => user.id === id)
    if (userIndex === -1) return null

    const updatedUser = {
      ...this.users[userIndex],
      ...updates,
      updatedAt: new Date().toISOString()
    }
    
    this.users[userIndex] = updatedUser
    return updatedUser
  }

  deleteUser(id: number): boolean {
    const initialLength = this.users.length
    this.users = this.users.filter(user => user.id !== id)
    return this.users.length < initialLength
  }
}

export const dataStore = new DataStore()
```

### 2.4 유틸리티 함수

```typescript
// src/lib/api-utils.ts
import { NextRequest, NextResponse } from 'next/server'
import { ApiResponse } from '@/types/user'

export function createSuccessResponse<T>(data: T, message?: string): NextResponse {
  const response: ApiResponse<T> = {
    success: true,
    data,
    message
  }
  return NextResponse.json(response)
}

export function createErrorResponse(error: string, status: number = 400): NextResponse {
  const response: ApiResponse<never> = {
    success: false,
    error
  }
  return NextResponse.json(response, { status })
}

export async function validateRequestBody(request: NextRequest) {
  try {
    return await request.json()
  } catch {
    throw new Error('Invalid JSON in request body')
  }
}

export function validateEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  return emailRegex.test(email)
}
```

---

## 3. 실습: 간단한 REST API 구현

### 3.1 사용자 목록 및 생성 API

```typescript
// src/app/api/users/route.ts
import { NextRequest } from 'next/server'
import { dataStore } from '@/lib/data-store'
import { 
  createSuccessResponse, 
  createErrorResponse, 
  validateRequestBody,
  validateEmail 
} from '@/lib/api-utils'
import { CreateUserRequest } from '@/types/user'

// GET /api/users - 모든 사용자 조회
export async function GET() {
  try {
    const users = dataStore.getAllUsers()
    return createSuccessResponse(users, `${users.length}명의 사용자를 조회했습니다.`)
  } catch (error) {
    return createErrorResponse('사용자 조회 중 오류가 발생했습니다.', 500)
  }
}

// POST /api/users - 새 사용자 생성
export async function POST(request: NextRequest) {
  try {
    const body: CreateUserRequest = await validateRequestBody(request)
    
    // 유효성 검사
    if (!body.name || !body.email) {
      return createErrorResponse('이름과 이메일은 필수 항목입니다.')
    }

    if (!validateEmail(body.email)) {
      return createErrorResponse('유효하지 않은 이메일 형식입니다.')
    }

    // 이메일 중복 확인
    const existingUsers = dataStore.getAllUsers()
    if (existingUsers.some(user => user.email === body.email)) {
      return createErrorResponse('이미 존재하는 이메일입니다.')
    }

    const newUser = dataStore.createUser(body.name, body.email)
    return createSuccessResponse(newUser, '사용자가 성공적으로 생성되었습니다.')
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : '사용자 생성 중 오류가 발생했습니다.'
    return createErrorResponse(errorMessage, 500)
  }
}
```

### 3.2 개별 사용자 조회, 수정, 삭제 API

```typescript
// src/app/api/users/[id]/route.ts
import { NextRequest } from 'next/server'
import { dataStore } from '@/lib/data-store'
import { 
  createSuccessResponse, 
  createErrorResponse, 
  validateRequestBody,
  validateEmail 
} from '@/lib/api-utils'
import { UpdateUserRequest } from '@/types/user'

interface RouteParams {
  params: {
    id: string
  }
}

// GET /api/users/[id] - 특정 사용자 조회
export async function GET(request: NextRequest, { params }: RouteParams) {
  try {
    const id = parseInt(params.id)
    
    if (isNaN(id)) {
      return createErrorResponse('유효하지 않은 사용자 ID입니다.')
    }

    const user = dataStore.getUserById(id)
    
    if (!user) {
      return createErrorResponse('사용자를 찾을 수 없습니다.', 404)
    }

    return createSuccessResponse(user, '사용자 정보를 조회했습니다.')
  } catch (error) {
    return createErrorResponse('사용자 조회 중 오류가 발생했습니다.', 500)
  }
}

// PUT /api/users/[id] - 사용자 정보 수정
export async function PUT(request: NextRequest, { params }: RouteParams) {
  try {
    const id = parseInt(params.id)
    
    if (isNaN(id)) {
      return createErrorResponse('유효하지 않은 사용자 ID입니다.')
    }

    const body: UpdateUserRequest = await validateRequestBody(request)

    // 이메일 유효성 검사
    if (body.email && !validateEmail(body.email)) {
      return createErrorResponse('유효하지 않은 이메일 형식입니다.')
    }

    // 이메일 중복 확인 (자신 제외)
    if (body.email) {
      const existingUsers = dataStore.getAllUsers()
      if (existingUsers.some(user => user.email === body.email && user.id !== id)) {
        return createErrorResponse('이미 존재하는 이메일입니다.')
      }
    }

    const updatedUser = dataStore.updateUser(id, body)
    
    if (!updatedUser) {
      return createErrorResponse('사용자를 찾을 수 없습니다.', 404)
    }

    return createSuccessResponse(updatedUser, '사용자 정보가 성공적으로 수정되었습니다.')
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : '사용자 수정 중 오류가 발생했습니다.'
    return createErrorResponse(errorMessage, 500)
  }
}

// DELETE /api/users/[id] - 사용자 삭제
export async function DELETE(request: NextRequest, { params }: RouteParams) {
  try {
    const id = parseInt(params.id)
    
    if (isNaN(id)) {
      return createErrorResponse('유효하지 않은 사용자 ID입니다.')
    }

    const deleted = dataStore.deleteUser(id)
    
    if (!deleted) {
      return createErrorResponse('사용자를 찾을 수 없습니다.', 404)
    }

    return createSuccessResponse(null, '사용자가 성공적으로 삭제되었습니다.')
  } catch (error) {
    return createErrorResponse('사용자 삭제 중 오류가 발생했습니다.', 500)
  }
}
```

### 3.3 프론트엔드 구현

Material UI를 사용한 사용자 관리 컴포넌트:

```typescript
// src/components/UserManager.tsx
'use client'

import React, { useState, useEffect } from 'react'
import {
  Box,
  Button,
  Card,
  CardContent,
  Container,
  Dialog,
  DialogActions,
  DialogContent,
  DialogTitle,
  IconButton,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TextField,
  Typography,
  Alert,
  CircularProgress
} from '@mui/material'
import { Add, Edit, Delete, Refresh } from '@mui/icons-material'
import { User, CreateUserRequest, UpdateUserRequest, ApiResponse } from '@/types/user'

export default function UserManager() {
  const [users, setUsers] = useState<User[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState<string | null>(null)
  
  // 대화상자 상태
  const [openDialog, setOpenDialog] = useState(false)
  const [dialogMode, setDialogMode] = useState<'create' | 'edit'>('create')
  const [selectedUser, setSelectedUser] = useState<User | null>(null)
  
  // 폼 상태
  const [formData, setFormData] = useState({
    name: '',
    email: ''
  })

  // 사용자 목록 조회
  const fetchUsers = async () => {
    setLoading(true)
    setError(null)
    
    try {
      const response = await fetch('/api/users')
      const result: ApiResponse<User[]> = await response.json()
      
      if (result.success && result.data) {
        setUsers(result.data)
        setSuccess(result.message || '사용자 목록을 조회했습니다.')
      } else {
        setError(result.error || '사용자 목록 조회에 실패했습니다.')
      }
    } catch (error) {
      setError('네트워크 오류가 발생했습니다.')
    } finally {
      setLoading(false)
    }
  }

  // 사용자 생성
  const createUser = async (userData: CreateUserRequest) => {
    try {
      const response = await fetch('/api/users', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
      })
      
      const result: ApiResponse<User> = await response.json()
      
      if (result.success) {
        setSuccess(result.message || '사용자가 생성되었습니다.')
        fetchUsers()
        return true
      } else {
        setError(result.error || '사용자 생성에 실패했습니다.')
        return false
      }
    } catch (error) {
      setError('네트워크 오류가 발생했습니다.')
      return false
    }
  }

  // 사용자 수정
  const updateUser = async (id: number, userData: UpdateUserRequest) => {
    try {
      const response = await fetch(`/api/users/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
      })
      
      const result: ApiResponse<User> = await response.json()
      
      if (result.success) {
        setSuccess(result.message || '사용자가 수정되었습니다.')
        fetchUsers()
        return true
      } else {
        setError(result.error || '사용자 수정에 실패했습니다.')
        return false
      }
    } catch (error) {
      setError('네트워크 오류가 발생했습니다.')
      return false
    }
  }

  // 사용자 삭제
  const deleteUser = async (id: number) => {
    if (!confirm('정말로 이 사용자를 삭제하시겠습니까?')) {
      return
    }
    
    try {
      const response = await fetch(`/api/users/${id}`, {
        method: 'DELETE'
      })
      
      const result: ApiResponse<null> = await response.json()
      
      if (result.success) {
        setSuccess(result.message || '사용자가 삭제되었습니다.')
        fetchUsers()
      } else {
        setError(result.error || '사용자 삭제에 실패했습니다.')
      }
    } catch (error) {
      setError('네트워크 오류가 발생했습니다.')
    }
  }

  // 대화상자 열기
  const openCreateDialog = () => {
    setDialogMode('create')
    setFormData({ name: '', email: '' })
    setOpenDialog(true)
  }

  const openEditDialog = (user: User) => {
    setDialogMode('edit')
    setSelectedUser(user)
    setFormData({ name: user.name, email: user.email })
    setOpenDialog(true)
  }

  // 폼 제출
  const handleSubmit = async () => {
    if (!formData.name.trim() || !formData.email.trim()) {
      setError('이름과 이메일을 입력해주세요.')
      return
    }

    let success = false
    
    if (dialogMode === 'create') {
      success = await createUser(formData)
    } else if (selectedUser) {
      success = await updateUser(selectedUser.id, formData)
    }

    if (success) {
      setOpenDialog(false)
    }
  }

  // 알림 자동 닫기
  useEffect(() => {
    if (error || success) {
      const timer = setTimeout(() => {
        setError(null)
        setSuccess(null)
      }, 5000)
      return () => clearTimeout(timer)
    }
  }, [error, success])

  // 초기 데이터 로드
  useEffect(() => {
    fetchUsers()
  }, [])

  return (
    <Container maxWidth="lg" sx={{ mt: 4, mb: 4 }}>
      <Box sx={{ mb: 3, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <Typography variant="h4" component="h1">
          사용자 관리
        </Typography>
        <Box>
          <Button
            variant="outlined"
            startIcon={<Refresh />}
            onClick={fetchUsers}
            disabled={loading}
            sx={{ mr: 2 }}
          >
            새로고침
          </Button>
          <Button
            variant="contained"
            startIcon={<Add />}
            onClick={openCreateDialog}
          >
            사용자 추가
          </Button>
        </Box>
      </Box>

      {error && (
        <Alert severity="error" sx={{ mb: 2 }} onClose={() => setError(null)}>
          {error}
        </Alert>
      )}

      {success && (
        <Alert severity="success" sx={{ mb: 2 }} onClose={() => setSuccess(null)}>
          {success}
        </Alert>
      )}

      <Card>
        <CardContent>
          {loading ? (
            <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
              <CircularProgress />
            </Box>
          ) : (
            <TableContainer component={Paper}>
              <Table>
                <TableHead>
                  <TableRow>
                    <TableCell>ID</TableCell>
                    <TableCell>이름</TableCell>
                    <TableCell>이메일</TableCell>
                    <TableCell>생성일</TableCell>
                    <TableCell>수정일</TableCell>
                    <TableCell align="center">작업</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {users.length === 0 ? (
                    <TableRow>
                      <TableCell colSpan={6} align="center">
                        등록된 사용자가 없습니다.
                      </TableCell>
                    </TableRow>
                  ) : (
                    users.map((user) => (
                      <TableRow key={user.id}>
                        <TableCell>{user.id}</TableCell>
                        <TableCell>{user.name}</TableCell>
                        <TableCell>{user.email}</TableCell>
                        <TableCell>
                          {new Date(user.createdAt).toLocaleDateString('ko-KR')}
                        </TableCell>
                        <TableCell>
                          {new Date(user.updatedAt).toLocaleDateString('ko-KR')}
                        </TableCell>
                        <TableCell align="center">
                          <IconButton
                            color="primary"
                            onClick={() => openEditDialog(user)}
                            size="small"
                          >
                            <Edit />
                          </IconButton>
                          <IconButton
                            color="error"
                            onClick={() => deleteUser(user.id)}
                            size="small"
                          >
                            <Delete />
                          </IconButton>
                        </TableCell>
                      </TableRow>
                    ))
                  )}
                </TableBody>
              </Table>
            </TableContainer>
          )}
        </CardContent>
      </Card>

      {/* 사용자 추가/수정 대화상자 */}
      <Dialog open={openDialog} onClose={() => setOpenDialog(false)} maxWidth="sm" fullWidth>
        <DialogTitle>
          {dialogMode === 'create' ? '사용자 추가' : '사용자 수정'}
        </DialogTitle>
        <DialogContent>
          <TextField
            autoFocus
            margin="dense"
            label="이름"
            fullWidth
            variant="outlined"
            value={formData.name}
            onChange={(e) => setFormData({ ...formData, name: e.target.value })}
            sx={{ mb: 2 }}
          />
          <TextField
            margin="dense"
            label="이메일"
            type="email"
            fullWidth
            variant="outlined"
            value={formData.email}
            onChange={(e) => setFormData({ ...formData, email: e.target.value })}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setOpenDialog(false)}>취소</Button>
          <Button onClick={handleSubmit} variant="contained">
            {dialogMode === 'create' ? '추가' : '수정'}
          </Button>
        </DialogActions>
      </Dialog>
    </Container>
  )
}
```

### 3.4 메인 페이지 구성

```typescript
// src/app/page.tsx
import UserManager from '@/components/UserManager'
import { AppBar, Toolbar, Typography, CssBaseline, ThemeProvider, createTheme } from '@mui/material'

const theme = createTheme({
  palette: {
    primary: {
      main: '#1976d2',
    },
    secondary: {
      main: '#dc004e',
    },
  },
})

export default function Home() {
  return (
    <ThemeProvider theme={theme}>
      <CssBaseline />
      <AppBar position="static">
        <Toolbar>
          <Typography variant="h6" component="div" sx={{ flexGrow: 1 }}>
            Next.js API Routes 실습
          </Typography>
        </Toolbar>
      </AppBar>
      <UserManager />
    </ThemeProvider>
  )
}
```

### 3.5 실행 및 테스트

1. **개발 서버 실행**:
   ```bash
   npm run dev -- --turbo
   ```

2. **API 엔드포인트 테스트**:
   - GET `/api/users` - 모든 사용자 조회
   - POST `/api/users` - 새 사용자 생성
   - GET `/api/users/[id]` - 특정 사용자 조회
   - PUT `/api/users/[id]` - 사용자 수정
   - DELETE `/api/users/[id]` - 사용자 삭제

3. **Postman이나 curl로 테스트**:
   ```bash
   # 사용자 생성
   curl -X POST http://localhost:3000/api/users \
     -H "Content-Type: application/json" \
     -d '{"name": "홍길동", "email": "hong@example.com"}'

   #