# 15. 동적 라우팅과 SEO

## 1) 개념 정리

### \[id].tsx 동적 라우팅 (Pages Router)

* 파일명에 **대괄호**를 쓰면 URL 세그먼트를 **파라미터**로 받습니다.
  예) `pages/posts/[slug].tsx` → `/posts/:slug`
* 데이터 패칭 방식 선택

  * **SSG**: `getStaticProps` + `getStaticPaths` (정적 생성, 빠름)

    * `fallback: false | true | 'blocking'`, `revalidate`로 **ISR** 지원
  * **SSR**: `getServerSideProps` (요청마다 최신 데이터)
* 대규모 사이트: “목록 SSG + 상세 SSG(=ISR)” 또는 “목록 SSR + 상세 SSG” 등 **하이브리드** 구성이 흔함.

### SEO를 위한 Head

* Pages Router에서 `next/head`의 `<Head>`로 문서 `<head>`에 메타 삽입:

  * `<title>`, `<meta name="description">`
  * **Canonical** 링크(중복 URL 정규화)
  * **Open Graph / Twitter Card** (소셜 미리보기)
  * **JSON-LD** 구조화 데이터(검색 특징 강화, 예: BlogPosting)

---

## 2) Next.js 프로젝트 생성 (TypeScript + Pages Router)

```bash
npx create-next-app@latest next-dynamic-seo --ts --no-app
cd next-dynamic-seo
npm run dev
```

---

## 3) 실습: 블로그 상세 페이지 (동적 라우팅 + SEO)

### 3-1) 타입/데이터 준비

```
src/
├─ lib/posts.ts
├─ pages/
│  ├─ index.tsx
│  └─ posts/
│     ├─ index.tsx
│     └─ [slug].tsx
└─ styles/globals.css
```

**`src/lib/posts.ts`**

```ts
export type Post = {
  slug: string;
  title: string;
  excerpt: string;
  body: string;
  date: string;      // ISO
  author: string;
  tags: string[];
  cover?: string;    // OG 이미지로 사용 가능
};

export const POSTS: Post[] = [
  {
    slug: 'hello-next-seo',
    title: 'Hello Next.js SEO',
    excerpt: '동적 라우팅과 Head로 SEO를 구성해 봅니다.',
    body: '본문 예시입니다. 검색/공유 미리보기 최적화를 진행합니다.',
    date: '2025-08-22',
    author: 'FE Chapter',
    tags: ['next', 'seo'],
    cover: '/og/hello.png',
  },
  {
    slug: 'dynamic-routes',
    title: '동적 라우트 입문',
    excerpt: '파일명에 대괄호를 사용해 파라미터를 받습니다.',
    body: 'SSG/SSR/ISR 등 렌더링 전략과 함께 사용합니다.',
    date: '2025-08-23',
    author: 'FE Chapter',
    tags: ['routes'],
  },
];

export function getAllSlugs(): string[] {
  return POSTS.map(p => p.slug);
}
export function getPostBySlug(slug: string) {
  return POSTS.find(p => p.slug === slug) ?? null;
}
```

### 3-2) 목록 페이지 (링크/프리패치)

**`src/pages/posts/index.tsx`**

```tsx
import Link from 'next/link';
import { POSTS } from '../../lib/posts';

export default function PostsIndex() {
  return (
    <main style={{ maxWidth: 900, margin: '0 auto', padding: 24 }}>
      <h1>블로그</h1>
      <ul style={{ listStyle: 'none', padding: 0, display: 'grid', gap: 12 }}>
        {POSTS.map(p => (
          <li key={p.slug} style={{ border: '1px solid #eee', borderRadius: 12, padding: 12 }}>
            <h3 style={{ margin: 0 }}>
              <Link href={`/posts/${p.slug}`}>{p.title}</Link>
            </h3>
            <p style={{ margin: '6px 0', color: '#4b5563' }}>{p.excerpt}</p>
          </li>
        ))}
      </ul>
    </main>
  );
}
```

### 3-3) 상세 페이지 (동적 라우팅 + SSG + Head)

**`.env.local`** (옵션)

```
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

**`src/pages/posts/[slug].tsx`**

```tsx
import Head from 'next/head';
import type { GetStaticPaths, GetStaticProps, InferGetStaticPropsType } from 'next';
import Link from 'next/link';
import { getAllSlugs, getPostBySlug, type Post } from '../../lib/posts';

type Props = { post: Post; canonical: string };

export default function PostPage({ post, canonical }: InferGetStaticPropsType<typeof getStaticProps>) {
  const title = `${post.title} | My Blog`;
  const desc = post.excerpt || post.body.slice(0, 120);
  const ogImage = post.cover ?? '/default-og.png';

  const jsonLd = {
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    headline: post.title,
    datePublished: post.date,
    author: { '@type': 'Person', name: post.author },
    image: ogImage,
    keywords: post.tags.join(','),
    description: desc
  };

  return (
    <main style={{ maxWidth: 900, margin: '0 auto', padding: 24, display: 'grid', gap: 12 }}>
      <Head>
        <title>{title}</title>
        <meta name="description" content={desc} />
        <link rel="canonical" href={canonical} />

        {/* Open Graph */}
        <meta property="og:type" content="article" />
        <meta property="og:title" content={post.title} />
        <meta property="og:description" content={desc} />
        <meta property="og:url" content={canonical} />
        <meta property="og:image" content={ogImage} />

        {/* Twitter */}
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={post.title} />
        <meta name="twitter:description" content={desc} />
        <meta name="twitter:image" content={ogImage} />

        {/* JSON-LD */}
        <script type="application/ld+json" dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }} />
      </Head>

      <Link href="/posts">← 목록</Link>
      <h1 style={{ marginBottom: 0 }}>{post.title}</h1>
      <small style={{ color: '#6b7280' }}>
        {new Date(post.date).toLocaleDateString()} • {post.author} • {post.tags.join(', ')}
      </small>
      <article style={{ marginTop: 8, lineHeight: 1.7 }}>{post.body}</article>
    </main>
  );
}

export const getStaticPaths: GetStaticPaths = async () => {
  const paths = getAllSlugs().map(slug => ({ params: { slug } }));
  return { paths, fallback: 'blocking' }; // 미등록 slug 최초 요청 시 생성
};

export const getStaticProps: GetStaticProps<Props> = async (ctx) => {
  const slug = ctx.params?.slug as string;
  const post = getPostBySlug(slug);
  if (!post) return { notFound: true };

  const origin = process.env.NEXT_PUBLIC_SITE_URL ?? 'http://localhost:3000';
  const canonical = `${origin}/posts/${post.slug}`;

  return {
    props: { post, canonical },
    revalidate: 60, // ISR: 60초마다 백그라운드 재생성
  };
};
```

### 3-4) 홈(선택)

**`src/pages/index.tsx`**

```tsx
import Link from 'next/link';
export default function Home() {
  return (
    <main style={{ padding: 24 }}>
      <h1>Next.js 동적 라우팅 + SEO 데모</h1>
      <p><Link href="/posts">블로그로 이동 →</Link></p>
    </main>
  );
}
```

> 여기까지: `/posts` 목록 → `/posts/[slug]` 상세로 이동하며, 상세에 **SEO 메타/OG/JSON-LD**가 반영됩니다.

---

## 4) 실습 미션 (Hands-on)

1. **목록 페이지 SEO**

   * `/posts`에 `<Head>`를 넣고 리스트 페이지용 `title/description/canonical` 구성.

2. **OG 이미지 동적 생성(옵션)**

   * `cover` 없을 때, `title`을 그려주는 **OG 생성 API**(예: `/api/og`)를 만들어 `og:image`에 사용.

3. **`fallback: 'blocking'` 체험**

   * `POSTS`에 없는 slug로 최초 접속 → 200ms 딜레이를 추가하고 **첫 요청 생성**과 이후 **캐시 히트** 차이를 관찰.

4. **SSR 버전으로 전환**

   * 상세 페이지를 `getServerSideProps`로 바꾸고 `req.headers.host`에서 `canonical`을 계산해보기.

5. **국제화(i18n) 메타**

   * 다국어를 가정하고 `hreflang` 링크 메타를 추가(ko, en).

---

## 5) 자주 하는 실수 & 베스트 프랙티스

* **중복/잘못된 canonical**: 프로토콜/도메인 포함 **절대 URL**로 지정하세요.
* **OG/Twitter 미설정**: 공유 썸네일/문구가 어색해집니다. 최소 `title/description/image`는 채우기.
* **JSON-LD 문법 오류**: 문자열 큰따옴표(JSON) 규칙 준수, 필드명 정확히.
* **`fallback` 오해**: `false`는 지정된 경로만, `'blocking'`은 첫 요청 시 서버에서 생성 후 응답.
* **빌드 타임 값 하드코딩**: `NEXT_PUBLIC_SITE_URL` 등 환경변수를 도입해 환경별(로컬/배포) canonical을 안정화.

---

## 6) 예상 질문(Q\&A)

**Q1. Pages Router 대신 App Router에선 어떻게 하나요?**
A. `app/posts/[slug]/page.tsx`로 라우팅하며, 메타는 **`generateMetadata`** 또는 레이아웃에서 설정합니다. JSON-LD는 동일하게 `<script>` 삽입.

**Q2. 제목/설명 길이는 어느 정도가 좋나요?**
A. 일반적으로 **title ≤ 60자**, **description 120\~160자** 권장(검색 스니펫 절단 방지).

**Q3. 동적 페이지가 수천 개면 `getStaticPaths`가 느려지지 않나요?**
A. `fallback: 'blocking'`으로 **부분 사전생성 + 점진적 생성(ISR)** 전략을 사용하세요.

**Q4. OG 이미지는 어디에 두나요?**
A. `/public/og/...`에 정적 파일로 두거나, **API/Edge**로 **동적 생성**하여 텍스트를 반영할 수 있습니다.

---

## (부록) Vite(React)로 “동적 라우팅 + SEO” 흉내 내기

> Next 없이 Vite에서 유사 학습을 하려면 **React Router + react-helmet-async**를 사용합니다.

### A. 프로젝트 준비

```bash
npm create vite@latest react-dynamic-seo -- --template react-swc-ts
cd react-dynamic-seo
npm i react-router-dom react-helmet-async
npm run dev
```

### B. 데이터/라우팅/SEO

**`src/data.ts`**

```ts
export type Post = { slug: string; title: string; excerpt: string; body: string; date: string };
export const POSTS: Post[] = [
  { slug: 'hello', title: 'Hello Vite SEO', excerpt: 'Helmet으로 메타 구성', body: '본문…', date: '2025-08-22' },
];
export const getPost = (slug: string) => POSTS.find(p => p.slug === slug) ?? null;
```

**`src/main.tsx`**

```tsx
import { createRoot } from 'react-dom/client';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { HelmetProvider } from 'react-helmet-async';
import App from './App';

createRoot(document.getElementById('root')!).render(
  <HelmetProvider>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </HelmetProvider>
);
```

**`src/App.tsx`**

```tsx
import { Routes, Route, Link } from 'react-router-dom';
import Posts from './pages/Posts';
import Post from './pages/Post';

export default function App() {
  return (
    <div style={{ padding: 24 }}>
      <h1>React Router + Helmet</h1>
      <nav><Link to="/posts">블로그</Link></nav>
      <Routes>
        <Route path="/posts" element={<Posts />} />
        <Route path="/posts/:slug" element={<Post />} />
      </Routes>
    </div>
  );
}
```

**`src/pages/Posts.tsx`**

```tsx
import { Link } from 'react-router-dom';
import { Helmet } from 'react-helmet-async';
import { POSTS } from '../data';

export default function Posts() {
  return (
    <main>
      <Helmet>
        <title>블로그 목록 | My App</title>
        <meta name="description" content="블로그 글 목록" />
        <link rel="canonical" href={`${location.origin}/posts`} />
      </Helmet>
      <h2>블로그</h2>
      <ul>
        {POSTS.map(p => <li key={p.slug}><Link to={`/posts/${p.slug}`}>{p.title}</Link></li>)}
      </ul>
    </main>
  );
}
```

**`src/pages/Post.tsx`**

```tsx
import { useParams, Link } from 'react-router-dom';
import { Helmet } from 'react-helmet-async';
import { getPost } from '../data';

export default function Post() {
  const { slug = '' } = useParams();
  const post = getPost(slug);
  if (!post) return <p>Not Found</p>;

  const title = `${post.title} | My App`;
  const desc = post.excerpt || post.body.slice(0, 120);
  const canonical = `${location.origin}/posts/${post.slug}`;

  return (
    <main>
      <Helmet>
        <title>{title}</title>
        <meta name="description" content={desc} />
        <link rel="canonical" href={canonical} />
        <meta property="og:title" content={post.title} />
        <meta property="og:description" content={desc} />
        <meta property="og:url" content={canonical} />
      </Helmet>

      <Link to="/posts">← 목록</Link>
      <h2>{post.title}</h2>
      <article>{post.body}</article>
    </main>
  );
}
```

> 이렇게 하면 Vite 환경에서도 \*\*동적 경로(react-router-dom)\*\*와 \*\*SEO 메타(react-helmet-async)\*\*를 체험할 수 있습니다.
> 다만, **SSR/SSG/ISR** 등 렌더링 전략은 Next.js의 영역입니다.

