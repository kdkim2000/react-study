# 18. 배포 (Vercel · 환경 변수 · 실습)

## 1) 개념 요약

* **Environments**

  * Local(로컬) · **Preview(브랜치/PR)** · **Production(실서비스)**. 환경별 **환경 변수**를 분리해 관리합니다. ([Vercel][1])
* **환경 변수 동기화**

  * 대시보드에서 설정하거나 CLI로 `vercel env pull` 로컬 `.env` 동기화가 가능합니다. ([Vercel][3])
* **배포 방식**

  * Git 연동(권장) 또는 **Vercel CLI**로 즉시 배포(`vercel`, `vercel --prod`). ([Vercel][4])
* **Vite + SPA 라우팅**

  * 새로고침 404를 막으려면 **`vercel.json`의 rewrites**로 모든 경로를 `/index.html`로 돌려주는 **SPA fallback**을 적용합니다(동일 프로젝트에 서버리스 API가 있다면 `/api/*`는 제외). ([Vercel][5])

---

## 2) 실습: Vite(React+TS) 앱을 Vercel에 배포

### 2-1) 준비 — 샘플 프로젝트(또는 기존 앱)

```bash
npm create vite@latest my-vite-app -- --template react-swc-ts
cd my-vite-app
npm i
npm run dev
```

### 2-2) API 주소를 환경 변수로 분리 (클라이언트에 노출될 값 → `VITE_` 접두사)

**`.env` (로컬/개발):**

```
VITE_API_BASE_URL=http://localhost:5174
```

**`src/api.ts` (예시):**

```ts
export const API_BASE = import.meta.env.VITE_API_BASE_URL as string;

export async function getHello() {
  const r = await fetch(`${API_BASE}/api/health`);
  if (!r.ok) throw new Error('failed');
  return r.json() as Promise<{ ok: boolean; ts: number }>;
}
```

> Vite에서는 **`import.meta.env.VITE_*`** 만 브라우저에 노출됩니다(서버 비밀 값은 절대 `VITE_`로 노출 금지).

### 2-3) SPA fallback(선택) — 클라이언트 라우팅 사용 시

**루트 `vercel.json`**

* 서버리스 API를 같은 프로젝트에서 쓰지 않는 **순수 프론트엔드**라면 첫 줄(`/api` 제외)도 필요 없습니다.

```json
{
  "rewrites": [
    { "source": "/api/:path*", "destination": "/api/:path*" },
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}
```

* 위 설정은 SPA 라우팅 새로고침 시 **404 대신** `index.html`을 반환합니다. ([Vercel][5])

### 2-4) Git 연동으로 배포 (권장)

1. GitHub에 리포 푸시 후 Vercel 대시보드에서 **“Add New → Project → Import”**
2. 프레임워크는 자동 감지(**Vite**)되고, **Build Command** = `npm run build`, **Output** = `dist/`. ([Vercel][2])
3. **Settings → Environment Variables**에서

   * **Preview**: `VITE_API_BASE_URL=https://api-staging.example.com`
   * **Production**: `VITE_API_BASE_URL=https://api.example.com`
     저장 후 재배포. (CLI로는 `vercel env pull`로 로컬에 내려받을 수 있습니다.) ([Vercel][3])
4. PR마다 **Preview URL**이 자동 생성, **Merge**되면 Production으로 배포됩니다. ([Vercel][1])

### 2-5) CLI로 바로 배포 (빠른 맛보기)

```bash
npm i -g vercel
vercel           # 미리보기(Preview) 배포, 프로젝트 연결
vercel --prod    # 프로덕션 배포
# 환경 변수 로컬 동기화
vercel env pull  # .env.local 생성
```

([Vercel][4])

---

## 3) 백엔드/DB가 있는 경우(참고)

* **Express API를 따로 운영**하는 경우:

  * CORS에 \*\*Vercel 도메인(Preview/Prod)\*\*을 허용하고, 프론트는 `VITE_API_BASE_URL`에 그 API 도메인을 넣습니다.
* **Prisma + Postgres(서버리스/수평 확장)**:

  * 서버리스에서 DB 연결 수 문제를 피하려면 **연결 풀링**이 필요합니다. **Neon(서버리스 Postgres) + Prisma Accelerate(풀러/프록시)** 조합을 권장합니다. ([Neon][6], [Prisma][7])

---

## 4) 실습 미션 (Hands-on)

1. **실배포**

   * 현재 Vite 앱을 GitHub → Vercel에 연결하고, Preview/Production 환경 변수를 분리해 설정하세요.
   * `npm run build` 후 미리보기 URL에서 라우팅/새로고침이 잘 되는지 확인합니다. (필요 시 `vercel.json`의 **rewrites** 점검) ([Vercel][5])

2. **API 연동 검증**

   * `VITE_API_BASE_URL`을 실제 백엔드로 교체하고, 네트워크 탭으로 CORS/HTTPS/도메인 설정을 점검하세요.

3. **CLI 동기화**

   * 로컬 개발자가 바뀌어도 동일하게 실행되도록 `vercel env pull`로 `.env.local`을 팀과 맞추세요. ([Vercel][3])

4. **Preview 실무 플로우**

   * 기능 브랜치 → PR 생성 → 자동 Preview URL에서 QA → 승인 후 머지 → 자동 Production 배포를 경험해 보세요. ([Vercel][1])

---

## 5) 체크리스트

* [ ] SPA 라우팅 새로고침 404? → `vercel.json` **rewrites** 확인. ([Vercel][5])
* [ ] 환경 변수 노출 범위 분리? (`VITE_*` 만 브라우저 노출)
* [ ] Preview/Prod **서로 다른 API 주소** 적용? (대시보드/CLI로 스코프 지정) ([Vercel][3])
* [ ] CLI로 로컬 `.env` 동기화 완료? `vercel env pull` ([Vercel][3])
* [ ] DB 연결(서버리스) → **풀링(Prisma Accelerate/Neon)** 적용? ([Prisma][7], [Neon][6])

---

## 6) 예상 질문(Q\&A)

**Q1. Vite 앱인데 새로고침 하면 404가 떠요.**
A. SPA는 서버가 모든 경로에 대해 `index.html`을 반환해야 합니다. `vercel.json`에 **rewrites**를 추가하세요(동일 프로젝트에 API가 있으면 `/api/*`는 제외). ([Vercel][5])

**Q2. 환경 변수를 로컬과 Vercel에서 맞추려면?**
A. 대시보드에서 값을 넣고 `vercel env pull`로 로컬 `.env.local`을 받으세요. Preview/Production 스코프를 분리해 운영하세요. ([Vercel][3])

**Q3. Git 없이 바로 올릴 수 있나요?**
A. 가능합니다. **Vercel CLI**에서 `vercel`로 Preview, `vercel --prod`로 Production 배포가 됩니다. ([Vercel][4])

**Q4. Express + Prisma 백엔드는 Vercel에 같이 올릴까요?**
A. 가능하지만(서버리스 함수), **DB 연결 수/지속성** 이슈가 있습니다. 보통은 **프론트는 Vercel**, 백엔드는 **전용 호스팅**(예: Render/Fly) 또는 **풀링 적용** 후 Vercel Functions로 운영을 고려합니다. **Neon + Prisma Accelerate** 가이드를 참고하세요. ([Prisma][7], [Neon][6])

**Q5. Vite의 `base` 설정은?**
A. 루트(예: 커스텀 도메인)라면 기본값(`/`)이면 충분합니다. 정적 배포 가이드를 참고하세요. ([vitejs][8])

---

## (참고) Next.js도 배포하고 싶다면

Next.js는 Vercel에서 **완전 자동 감지**(SSR/SSG/ISR, 이미지 최적화 등)됩니다. 환경 변수는 **Settings → Environment Variables**에서 넣고 \*\*`process.env.*`\*\*로 사용하세요(클라이언트 노출은 `NEXT_PUBLIC_*`). ([Vercel][2])

---

원하시면, 지금 만든 Vite 예제를 **실제 리포 구조**(코드/설정 파일 목록)로 정리해 드릴게요.

[1]: https://vercel.com/docs/deployments/environments?utm_source=chatgpt.com "Environments - Vercel"
[2]: https://vercel.com/docs/frameworks/frontend/vite?utm_source=chatgpt.com "Vite on Vercel"
[3]: https://vercel.com/docs/environment-variables?utm_source=chatgpt.com "Environment variables - Vercel"
[4]: https://vercel.com/docs/cli/deploying-from-cli?utm_source=chatgpt.com "Deploying Projects from Vercel CLI"
[5]: https://vercel.com/docs/rewrites?utm_source=chatgpt.com "Rewrites on Vercel"
[6]: https://neon.com/docs/guides/prisma?utm_source=chatgpt.com "Connect from Prisma to Neon - Neon Docs"
[7]: https://www.prisma.io/docs/guides/neon-accelerate?utm_source=chatgpt.com "Set up Neon with Accelerate Connection Pool - Prisma"
[8]: https://vite.dev/guide/static-deploy?utm_source=chatgpt.com "Deploying a Static Site | Vite"
